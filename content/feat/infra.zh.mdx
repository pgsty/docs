---
title: å¯è§‚æµ‹æ€§åŸºç¡€è®¾æ–½
description: å…·æœ‰ 3000+ æŒ‡æ ‡ã€30+ ä»ªè¡¨æ¿å’Œä¼ä¸šçº§ç›‘æ§çš„ç°ä»£å¯è§‚æµ‹æ€§å †æ ˆ
icon: Telescope
---

import { Callout } from 'fumadocs-ui/components/callout';
import { Tab, Tabs } from 'fumadocs-ui/components/tabs';
import { Card, Cards } from 'fumadocs-ui/components/card';
import { Step, Steps } from 'fumadocs-ui/components/steps';

Pigsty æä¾› **æ— ä¸ä¼¦æ¯”çš„å¯è§‚æµ‹æ€§**ï¼Œå…·æœ‰åŸºäºè¡Œä¸šæœ€ä½³å®è·µæ„å»ºçš„ç°ä»£ç›‘æ§å †æ ˆã€‚
è‡ªåŠ¨ç›‘æ§æ¯ä¸ªç»„ä»¶ï¼Œå…·æœ‰ **3000+ æŒ‡æ ‡**ã€**30+ ä»ªè¡¨æ¿**ã€‚

![](/img/pigsty/dashboard.gif)

<Callout type="info">
**å®Œæ•´æ´å¯Ÿ**ï¼šä»é«˜çº§é›†ç¾¤å¥åº·åˆ°å•ä¸ªè¡¨ç»Ÿè®¡çš„æ‰€æœ‰å†…å®¹è¿›è¡Œç›‘æ§ã€‚å®Œæ•´æ´å¯Ÿæ‚¨åŸºç¡€è®¾æ–½çš„è¿‡å»ã€ç°åœ¨å’Œæœªæ¥ã€‚
</Callout>


## æ¶æ„æ¦‚è¿° [#architecture-overview]

![](/img/pigsty/infra.png)

Pigsty çš„å¯è§‚æµ‹æ€§åŸºç¡€è®¾æ–½åœ¨ä¸€ä¸ªè¿è´¯çš„ã€ç”Ÿäº§å°±ç»ªçš„å †æ ˆä¸­åˆ©ç”¨ç»è¿‡å®æˆ˜è€ƒéªŒçš„å¼€æºç»„ä»¶ï¼š

<Cards>
<Card title="Grafana å¯è§†åŒ–å¼•æ“" icon="ğŸ“Š">
å…·æœ‰é«˜çº§äº¤äº’å¼å¯è§†åŒ–çš„ä»ªè¡¨æ¿
</Card>
<Card title="Prometheus æŒ‡æ ‡æ•°æ®åº“" icon="ğŸ“ˆ">
å…·æœ‰å¼ºå¤§æŸ¥è¯¢è¯­è¨€çš„æ—¶é—´åºåˆ—å­˜å‚¨
</Card>
<Card title="Loki æ—¥å¿—å¹³å°" icon="ğŸ“">
å…·æœ‰åŸºäºæ ‡ç­¾ç´¢å¼•çš„é›†ä¸­å¼æ—¥å¿—è®°å½•
</Card>
<Card title="AlertManager" icon="ğŸš¨">
å‘Šè­¦èšåˆã€ç®¡ç†å’Œå‡çº§
</Card>
</Cards>

### æœåŠ¡æ¶æ„ [#service-architecture]

```mermaid
graph TB
    subgraph "Observability Stack"
        Grafana[Grafana :3000]
        Prometheus[Prometheus :9058]
        Loki[Loki :3100]
        AlertManager[AlertManager :9059]
        Pushgateway[Pushgateway :9091]
        Blackbox[Blackbox :9115]
    end
    
    subgraph "Data Sources"
        PG[(PostgreSQL)]
        Node[Node Metrics]
        Redis[(Redis)]
        MinIO[(MinIO)]
    end
    
    subgraph "Exporters"
        PGExp[pg_exporter]
        NodeExp[node_exporter]
        RedisExp[redis_exporter]
        MinIOExp[minio_exporter]
    end
    
    PG --> PGExp
    Node --> NodeExp
    Redis --> RedisExp
    MinIO --> MinIOExp
    
    PGExp --> Prometheus
    NodeExp --> Prometheus
    RedisExp --> Prometheus
    MinIOExp --> Prometheus
    
    Prometheus --> Grafana
    Prometheus --> AlertManager
    Loki --> Grafana
```

--------

## ç›‘æ§ä»ªè¡¨æ¿ [#monitoring-dashboards]

### å¤šå±‚çº§ä»ªè¡¨æ¿å±‚æ¬¡ç»“æ„ [#multi-level-dashboard-hierarchy]

Pigsty æä¾›æŒ‰é€»è¾‘ä¸‹é’»å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ **26+ PostgreSQL ä»ªè¡¨æ¿**ï¼š

<Tabs items={['Overview Level', 'Cluster Level', 'Instance Level', 'Database Level']}>
<Tab value="Overview Level">
```yaml
# å…¨å±€æ¦‚è§ˆä»ªè¡¨æ¿
dashboards:
  - Home: å…¨å±€é›†ç¾¤æ¦‚è§ˆå’Œå…³é”®æŒ‡æ ‡
  - INFRA: åŸºç¡€è®¾æ–½æœåŠ¡çŠ¶æ€
  - NODES: èŠ‚ç‚¹çº§èµ„æºåˆ©ç”¨ç‡
  - Alert: æ´»è·ƒå‘Šè­¦å’Œé€šçŸ¥çŠ¶æ€
```
**ç›®çš„**ï¼šæ•´ä¸ªç¯å¢ƒçš„é«˜çº§è¿è¥å¯è§æ€§
**å—ä¼—**ï¼šè¿è¥å›¢é˜Ÿã€ç®¡ç†ä»ªè¡¨æ¿
</Tab>
<Tab value="Cluster Level">
```yaml
# é›†ç¾¤ç„¦ç‚¹ä»ªè¡¨æ¿
dashboards:
  - PGSQL Cluster: é›†ç¾¤å¥åº·å’Œå¤åˆ¶çŠ¶æ€
  - PGSQL Service: æœåŠ¡ç«¯ç‚¹å’Œè´Ÿè½½å‡è¡¡
  - PGSQL Activity: è¿æ¥æ± å’ŒæŸ¥è¯¢æ´»åŠ¨
  - PGSQL Replication: æµå¤åˆ¶æŒ‡æ ‡
```
**ç›®çš„**ï¼šé›†ç¾¤èŒƒå›´çš„ PostgreSQL æ€§èƒ½å’Œå¥åº·
**å—ä¼—**ï¼šæ•°æ®åº“ç®¡ç†å‘˜ã€SRE å›¢é˜Ÿ
</Tab>
<Tab value="Instance Level">
```yaml
# å®ä¾‹ç‰¹å®šä»ªè¡¨æ¿
dashboards:
  - PGSQL Instance: è¯¦ç»†çš„ PostgreSQL æœåŠ¡å™¨æŒ‡æ ‡
  - PGSQL Persist: WALã€æ£€æŸ¥ç‚¹å’ŒæŒä¹…åŒ–
  - PGSQL Proxy: Pgbouncer è¿æ¥æ± æŒ‡æ ‡
  - PGSQL Session: æ´»è·ƒä¼šè¯å’Œé”åˆ†æ
```
**ç›®çš„**ï¼šæ·±å…¥äº†è§£å•ä¸ª PostgreSQL å®ä¾‹
**å—ä¼—**ï¼šæ•°æ®åº“å¼€å‘äººå‘˜ã€æ€§èƒ½å·¥ç¨‹å¸ˆ
</Tab>
<Tab value="Database Level">
```yaml
# æ•°æ®åº“å’Œå¯¹è±¡çº§ä»ªè¡¨æ¿
dashboards:
  - PGSQL Database: æ•°æ®åº“ç‰¹å®šæ€§èƒ½æŒ‡æ ‡
  - PGSQL Table: è¡¨ç»Ÿè®¡å’Œè®¿é—®æ¨¡å¼
  - PGSQL Query: æŸ¥è¯¢æ€§èƒ½å’Œä¼˜åŒ–
  - PGSQL Slow: æ…¢æŸ¥è¯¢åˆ†æå’Œè°ƒä¼˜
```
**ç›®çš„**ï¼šåº”ç”¨çº§æ•°æ®åº“æ€§èƒ½åˆ†æ
**å—ä¼—**ï¼šåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ã€æ•°æ®åº“åˆ†æå¸ˆ
</Tab>
</Tabs>

### ä»ªè¡¨æ¿åŠŸèƒ½ [#dashboard-features]

<Cards>
<Card title="ä¸‹é’»å¯¼èˆª" icon="ğŸ”">
**æ— ç¼æ¢ç´¢** ä»æ¦‚è§ˆåˆ°è¯¦ç»†ä¿¡æ¯ï¼Œå…·æœ‰ä¸Šä¸‹æ–‡é“¾æ¥
</Card>
<Card title="æ—¶é—´èŒƒå›´æ§åˆ¶" icon="â°">
**çµæ´»çš„æ—¶é—´çª—å£** ä»å®æ—¶åˆ°æ•°æœˆçš„å†å²åˆ†æ
</Card>
<Card title="å¤šç»´è¿‡æ»¤" icon="ğŸ¯">
**åŠ¨æ€è¿‡æ»¤** æŒ‰é›†ç¾¤ã€å®ä¾‹ã€æ•°æ®åº“æˆ–è‡ªå®šä¹‰æ ‡ç­¾
</Card>
<Card title="å‘Šè­¦é›†æˆ" icon="ğŸš¨">
**å¯è§†åŒ–å‘Šè­¦å…³è”** ä¸æŒ‡æ ‡å’Œå‘Šè­¦è¯¦æƒ…çš„ç›´æ¥é“¾æ¥
</Card>
</Cards>

--------

## Grafana éƒ¨ç½² [#grafana-deployment]

### å¢å¼ºçš„ Grafana å †æ ˆ [#enhanced-grafana-stack]

Pigsty ä½¿ç”¨å¼ºå¤§çš„æ’ä»¶å’Œæ•°æ®æºæ‰©å±• Grafanaï¼Œç”¨äºé«˜çº§åˆ†æï¼š

<Tabs items={['Core Plugins', 'Visualization Plugins', 'Data Sources', 'Custom Extensions']}>
<Tab value="Core Plugins">
```yaml
# åŸºæœ¬ Grafana æ’ä»¶
grafana_plugins:
  - grafana-piechart-panel        # é¥¼å›¾å¯è§†åŒ–
  - grafana-polystat-panel        # å¤šå€¼çŠ¶æ€é¢æ¿
  - grafana-worldmap-panel        # åœ°ç†å¯è§†åŒ–
  - grafana-clock-panel           # æ—¶é—´æ˜¾ç¤ºå°éƒ¨ä»¶
```
**ç›®çš„**ï¼šç›‘æ§ä»ªè¡¨æ¿çš„åŸºæœ¬å¯è§†åŒ–åŠŸèƒ½
</Tab>
<Tab value="Visualization Plugins">
```yaml
# é«˜çº§å¯è§†åŒ–æ’ä»¶
grafana_plugins:
  - echarts-panel                 # Apache ECharts é›†æˆ
  - volkovlabs-echarts-panel      # å¢å¼ºçš„ ECharts æ”¯æŒ
  - volkovlabs-form-panel         # äº¤äº’å¼è¡¨å•
  - volkovlabs-variable-panel     # åŠ¨æ€å˜é‡
```
**ç›®çš„**ï¼šç”¨äºå¤æ‚æ•°æ®åˆ†æçš„ä¸°å¯Œäº¤äº’å¼å¯è§†åŒ–
</Tab>
<Tab value="Data Sources">
```yaml
# æ‰©å±•æ•°æ®æºæ”¯æŒ
grafana_datasources:
  - infinity-datasource           # REST API å’Œæ–‡ä»¶æ•°æ®æº
  - redis-datasource              # Redis æ•°æ®æº
  - clickhouse-datasource         # ClickHouse é›†æˆ
  - postgres-datasource           # å¢å¼ºçš„ PostgreSQL æ”¯æŒ
```
**ç›®çš„**ï¼šè¿æ¥åˆ°ä¼ ç»ŸæŒ‡æ ‡ä¹‹å¤–çš„å¤šæ ·åŒ–æ•°æ®æº
</Tab>
<Tab value="Custom Extensions">
```yaml
# Pigsty ç‰¹å®šå®šåˆ¶
custom_features:
  - pigsty-theme                  # è‡ªå®šä¹‰å“ç‰Œå’Œé¢œè‰²
  - dashboard-provisioning       # è‡ªåŠ¨åŒ–ä»ªè¡¨æ¿éƒ¨ç½²
  - alert-templates               # é¢„é…ç½®å‘Šè­¦è§„åˆ™
  - data-link-automation          # ä¸Šä¸‹æ–‡æ„ŸçŸ¥å¯¼èˆª
```
**ç›®çš„**ï¼šä¸º PostgreSQL ç¯å¢ƒä¼˜åŒ–çš„å®šåˆ¶ç”¨æˆ·ä½“éªŒ
</Tab>
</Tabs>

### é…ç½®å’Œå®šåˆ¶ [#configuration-customization]

```yaml
# é«˜çº§ Grafana é…ç½®
grafana_config:
  # è®¤è¯
  auth.anonymous.enabled: true
  auth.anonymous.org_role: Viewer
  auth.disable_login_form: false
  
  # å®‰å…¨æ€§
  security.allow_embedding: true
  security.cookie_secure: true
  security.cookie_samesite: strict
  
  # æ€§èƒ½
  database.max_open_conn: 300
  database.max_idle_conn: 300
  database.conn_max_lifetime: 14400
  
  # å‘Šè­¦
  alerting.enabled: true
  alerting.execute_alerts: true
  unified_alerting.enabled: true
  
  # è‡ªå®šä¹‰é¢æ¿
  panels.enable_alpha: true
  feature_toggles.enable: ngalert,live,publicDashboards
```

--------

## Prometheus å †æ ˆ [#prometheus-stack]

### å®Œæ•´çš„ç›‘æ§ç”Ÿæ€ç³»ç»Ÿ [#complete-monitoring-ecosystem]

Pigsty éƒ¨ç½²å®Œæ•´çš„ Prometheus ç”Ÿæ€ç³»ç»Ÿä»¥å®ç°å…¨é¢çš„å¯è§‚æµ‹æ€§ï¼š

<Steps>

<Step>
### Prometheus æœåŠ¡å™¨ [#prometheus-server]
**æ ¸å¿ƒæŒ‡æ ‡æ•°æ®åº“** å…·æœ‰é«˜çº§æŸ¥è¯¢å’Œå­˜å‚¨åŠŸèƒ½
```yaml
# Prometheus é…ç½®äº®ç‚¹
prometheus_config:
  global:
    scrape_interval: 15s          # é»˜è®¤æŠ“å–é¢‘ç‡
    evaluation_interval: 15s      # è§„åˆ™è¯„ä¼°é¢‘ç‡
    external_labels:
      cluster: '{{ pg_cluster }}'
      
  rule_files:
    - "/etc/prometheus/rules/*.yml"
    
  scrape_configs:
    - job_name: 'node'            # èŠ‚ç‚¹çº§æŒ‡æ ‡
    - job_name: 'postgres'        # PostgreSQL æŒ‡æ ‡
    - job_name: 'redis'           # Redis æŒ‡æ ‡
    - job_name: 'pushgateway'     # æ‰¹å¤„ç†ä½œä¸šæŒ‡æ ‡
```
</Step>

<Step>
### AlertManager [#alertmanager]
**æ™ºèƒ½å‘Šè­¦è·¯ç”±** å…·æœ‰æŠ‘åˆ¶ã€åˆ†ç»„å’Œå‡çº§åŠŸèƒ½
```yaml
# AlertManager è·¯ç”±é…ç½®
alertmanager_routes:
  - match:
      severity: critical
    receiver: pagerduty-critical
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h
    
  - match:
      severity: warning  
    receiver: slack-warnings
    group_wait: 1m
    group_interval: 10m
    repeat_interval: 24h
```
</Step>

<Step>
### Pushgateway [#pushgateway]
**æ‰¹å¤„ç†ä½œä¸šæŒ‡æ ‡æ”¶é›†** ç”¨äºçŸ­æš‚å·¥ä½œè´Ÿè½½å’Œ cron ä½œä¸š
```bash
# ç¤ºä¾‹ï¼šå¤‡ä»½ä½œä¸šæŒ‡æ ‡
echo "backup_duration_seconds $(date +%s)" | curl --data-binary @- \
  http://pushgateway:9091/metrics/job/pg-backup/instance/pg-test
```
</Step>

<Step>
### Blackbox Exporter [#blackbox-exporter]
**ç½‘ç»œè¿æ¥ç›‘æ§** å…·æœ‰ HTTPã€TCP å’Œ ICMP æ¢æµ‹
```yaml
# Blackbox æ¢æµ‹é…ç½®
blackbox_probes:
  http_2xx:
    prober: http
    timeout: 5s
    http:
      valid_status_codes: [200]
      
  tcp_connect:
    prober: tcp
    timeout: 5s
```
</Step>

</Steps>

### é¢„é…ç½®å‘Šè­¦è§„åˆ™ [#pre-configured-alert-rules]

```yaml
# PostgreSQL å‘Šè­¦è§„åˆ™ç¤ºä¾‹
alert_rules:
  - alert: PostgreSQLDown
    expr: pg_up == 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "PostgreSQL å®ä¾‹ {{ $labels.instance }} å·²å®•æœº"
      
  - alert: PostgreSQLHighConnections
    expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }} ä¸Šè¿æ¥ä½¿ç”¨ç‡è¿‡é«˜"
      
  - alert: PostgreSQLReplicationLag  
    expr: pg_replication_lag_seconds > 300
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "{{ $labels.instance }} ä¸Šå¤åˆ¶å»¶è¿Ÿ > 5 åˆ†é’Ÿ"
```

--------

## pg_exporterï¼šé«˜çº§ PostgreSQL ç›‘æ§ [#pg-exporter-advanced-postgresql-monitoring]

### è‡ªå®šä¹‰æŒ‡æ ‡å¼•æ“ [#custom-metrics-engine]

Pigsty çš„ [pg_exporter](https://github.com/pgsty/pg_exporter) æ˜¯ä¸€ä¸ªé«˜åº¦å¯å®šåˆ¶çš„ PostgreSQL æŒ‡æ ‡æ”¶é›†å™¨ï¼Œæ”¯æŒ **æ‰€æœ‰ PostgreSQL ç‰ˆæœ¬**ï¼Œå…·æœ‰ç»†ç²’åº¦æŒ‡æ ‡æ§åˆ¶ï¼š

<Tabs items={['Core Features', 'Version Compatibility', 'Custom Queries', 'RDS Support']}>
<Tab value="Core Features">
```yaml
# pg_exporter å…³é”®åŠŸèƒ½
features:
  - auto_discovery: true          # è‡ªåŠ¨æ•°æ®åº“å‘ç°
  - custom_queries: true          # ç”¨æˆ·å®šä¹‰æŒ‡æ ‡æŸ¥è¯¢
  - version_aware: true           # PostgreSQL ç‰ˆæœ¬æ£€æµ‹
  - rds_compatible: true          # äº‘æ•°æ®åº“æ”¯æŒ
  - label_customization: true     # çµæ´»çš„æŒ‡æ ‡æ ‡ç­¾
  - connection_pooling: true      # é«˜æ•ˆè¿æ¥é‡ç”¨
```
**ä¼˜åŠ¿**ï¼šçµæ´»ã€è½»é‡çº§ä¸”é«˜åº¦å¯é…ç½®
</Tab>
<Tab value="Version Compatibility">
```yaml
# PostgreSQL ç‰ˆæœ¬æ”¯æŒçŸ©é˜µ
supported_versions:
  - postgresql_9_6: legacy_metrics_set
  - postgresql_10: enhanced_metrics_set  
  - postgresql_11: advanced_metrics_set
  - postgresql_12: modern_metrics_set
  - postgresql_13: extended_metrics_set
  - postgresql_14: latest_metrics_set
  - postgresql_15: cutting_edge_metrics_set
  - postgresql_16: next_gen_metrics_set
```
**å¥½å¤„**ï¼šå¼‚æ„ PostgreSQL ç¯å¢ƒçš„å•ä¸€ exporter
</Tab>
<Tab value="Custom Queries">
```yaml
# è‡ªå®šä¹‰æŒ‡æ ‡å®šä¹‰ç¤ºä¾‹
custom_queries:
  pg_custom_business_metrics:
    query: |
      SELECT 
        schemaname,
        tablename,
        n_tup_ins as inserts_total,
        n_tup_upd as updates_total,
        n_tup_del as deletes_total
      FROM pg_stat_user_tables
    metrics:
      - inserts_total:
          usage: COUNTER
          description: "æ’å…¥æ€»æ•°"
      - updates_total:
          usage: COUNTER  
          description: "æ›´æ–°æ€»æ•°"
```
</Tab>
<Tab value="RDS Support">
```yaml
# RDS ç›‘æ§é…ç½®
rds_monitoring:
  connection_string: "postgres://monitor:password@rds.region.rds.amazonaws.com:5432/postgres"
  metrics_subset: rds_safe        # ä»… RDS å…¼å®¹æŒ‡æ ‡
  auto_discovery: false           # æ‰‹åŠ¨æ•°æ®åº“è§„èŒƒ
  query_timeout: 30s              # ä¿å®ˆè¶…æ—¶
  
  # RDS ç‰¹å®šæŒ‡æ ‡
  included_databases: [production, staging]
  excluded_schemas: [information_schema, pg_catalog]
```
</Tab>
</Tabs>

## æœ€ä½³å®è·µ [#best-practices]

### æ€§èƒ½ä¼˜åŒ– [#performance-optimization]

<Callout type="warn">
**èµ„æºè§„åˆ’**ï¼šç›‘æ§åŸºç¡€è®¾æ–½å¯èƒ½æ¶ˆè€—å¤§é‡èµ„æºã€‚ç›¸åº”åœ°è§„åˆ’æŒ‡æ ‡ä¿ç•™å’ŒæŸ¥è¯¢æ€§èƒ½ã€‚
</Callout>

- **æŒ‡æ ‡åŸºæ•°**ï¼šé™åˆ¶é«˜åŸºæ•°æ ‡ç­¾ä»¥é˜²æ­¢å­˜å‚¨çˆ†ç‚¸
- **ä¿ç•™ç­–ç•¥**ï¼šå¹³è¡¡å†å²æ•°æ®éœ€æ±‚ä¸å­˜å‚¨æˆæœ¬
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šå¯¹é¢‘ç¹è®¿é—®çš„æŒ‡æ ‡ä½¿ç”¨è®°å½•è§„åˆ™
- **ä»ªè¡¨æ¿æ€§èƒ½**ï¼šä¼˜åŒ–é¢æ¿æŸ¥è¯¢å’Œæ—¶é—´èŒƒå›´

### å®‰å…¨è€ƒè™‘ [#security-considerations]

```yaml
# å®‰å…¨æœ€ä½³å®è·µ
security_config:
  authentication:
    - ldap_integration: true
    - oauth_providers: [github, google, okta]
    - api_key_rotation: automated
    
  authorization:
    - role_based_access: true
    - team_based_folders: true
    - dashboard_permissions: granular
    
  network_security:
    - tls_encryption: enforced
    - firewall_rules: restrictive
    - reverse_proxy: nginx
```

---

Pigsty çš„å¯è§‚æµ‹æ€§åŸºç¡€è®¾æ–½å°†ç›‘æ§ä»è¢«åŠ¨çš„äº‹åæ€è€ƒè½¬å˜ä¸ºä¸»åŠ¨çš„è¿è¥ä¼˜åŠ¿ã€‚é€šè¿‡å…¨é¢çš„æŒ‡æ ‡ã€ç›´è§‚çš„ä»ªè¡¨æ¿å’Œçµæ´»çš„æ¶æ„ï¼Œæ‚¨å¯ä»¥æ·±å…¥äº†è§£æ•°æ®åº“åŸºç¡€è®¾æ–½çš„æ¯ä¸ªæ–¹é¢ã€‚